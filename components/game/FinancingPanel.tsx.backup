'use client'

import { motion, AnimatePresence } from 'framer-motion'
import { useGameStore } from '@/lib/gameStore'
import { FinancingLevers, MandatPeriod } from '@/lib/types'
import { BASE_PRICES } from '@/lib/data'
import { Switch } from '@/components/ui/switch'
import { Slider } from '@/components/ui/slider'
import { formatCurrency, cn } from '@/lib/utils'
import { 
  Coins, 
  Users, 
  CreditCard,
  Building2,
  Percent,
  AlertTriangle,
  Info,
  Lightbulb,
  ChevronDown,
  ChevronUp,
  Gavel,
  Moon,
  GraduationCap,
  X
} from 'lucide-react'
import { useState } from 'react'

interface LeverInfo {
  title: string
  description: string
  impact: string
  warning?: string
  icon: React.ElementType
  color: string
  requiresLaw?: boolean
  lawType?: string
}

const leverInfos: Record<string, LeverInfo> = {
  gratuiteTotale: {
    title: "Gratuité Totale",
    description: "Rendre tous les transports gratuits pour tous les usagers. Active cette option pour bloquer les modifications de tarifs et les remettre à zéro.",
    impact: "-1 925 M€/mandat",
    warning: "⚠️ Bloque la possibilité de jouer avec les tarifs et remet les prix à leur valeur initiale.",
    icon: Users,
    color: "from-red-500 to-rose-600",
  },
  gratuiteConditionnee: {
    title: "Gratuité Conditionnée (Proposition Aulas)",
    description: "Gratuité réservée aux habitants de Lyon uniquement (pas les autres communes de la métropole) et dont les revenus sont inférieurs à 2 500€/mois.",
    impact: "-300 M€/mandat",
    warning: "Mesure sociale ciblée excluant les non-lyonnais et les revenus supérieurs à 2 500€.",
    icon: Users,
    color: "from-orange-500 to-amber-600",
  },
  gratuiteJeunesAbonnes: {
    title: "Gratuité 11-18 ans enfants d'abonnés",
    description: "Gratuité des transports TCL pour les jeunes de 11 à 18 ans dont au moins un parent est abonné TCL.",
    impact: "-48 M€/mandat",
    icon: GraduationCap,
    color: "from-pink-500 to-rose-600",
  },
  metro24hWeekend: {
    title: "Métro 24h/24 les weekends",
    description: "Ouverture du métro toute la nuit les vendredis et samedis soirs pour faciliter les sorties nocturnes.",
    impact: "-24 M€/mandat",
    icon: Moon,
    color: "from-indigo-500 to-purple-600",
  },
  tarifAbonnements: {
    title: "Tarif Abonnements",
    description: "Ajuster le prix des abonnements mensuels.",
    impact: "+12 M€ par +1%",
    icon: CreditCard,
    color: "from-blue-500 to-cyan-600",
  },
  tarifTickets: {
    title: "Tarif Tickets",
    description: "Ajuster le prix du ticket unitaire.",
    impact: "+8 M€ par +1%",
    icon: CreditCard,
    color: "from-purple-500 to-pink-600",
  },
  versementMobilite: {
    title: "Versement Mobilité",
    description: "Taxation des entreprises de plus de 11 salariés pour financer les transports en commun. Baisser le taux peut se faire sans loi, mais l'augmenter nécessite une loi nationale.",
    impact: "±700 M€ par ±25%",
    warning: "⚖️ Augmenter le taux nécessite une loi nationale.",
    icon: Building2,
    color: "from-green-500 to-emerald-600",
    requiresLaw: true,
    lawType: "Versement Mobilité",
  },
  tva55: {
    title: "TVA à 5,5%",
    description: "Passage de la TVA de 10% à 5,5% sur les transports publics.",
    impact: "+96 M€/mandat",
    warning: "⚖️ Nécessite une décision gouvernementale.",
    icon: Percent,
    color: "from-teal-500 to-cyan-600",
    requiresLaw: true,
    lawType: "TVA réduite",
  },
  electrificationBus: {
    title: "Électrification des Bus",
    description: "Conversion de la flotte de bus thermiques vers l'électrique. Réduction des émissions et du bruit, mais coût initial important.",
    impact: "460 M€ total",
    warning: "⚠️ Désactiver augmentera les coûts de maintenance, de carburant et la pollution sur le long terme. C'est perdant économiquement et écologiquement.",
    icon: Building2,
    color: "from-green-500 to-teal-600",
  },
  entretienBus: {
    title: "Entretien Flotte de Bus",
    description: "Maintenance et renouvellement de la flotte de bus TCL. Indispensable pour maintenir la qualité de service sur l'ensemble du réseau.",
    impact: "800 M€ total",
    warning: "⚠️ Désactiver dégradera la qualité de service et augmentera les pannes. Obligatoire pour un réseau fonctionnel.",
    icon: Building2,
    color: "from-orange-500 to-red-600",
  },
}

export function GameFinancingPanel() {
  const { financingLevers, setFinancingLever, getBudgetState } = useGameStore()
  const [expandedLever, setExpandedLever] = useState<string | null>(null)
  const [lawPopup, setLawPopup] = useState<{ show: boolean; lawType: string; onConfirm: () => void } | null>(null)
  const [budgetWarning, setBudgetWarning] = useState<{ show: boolean; deficit: number } | null>(null)
  const [electrificationWarning, setElectrificationWarning] = useState<{ show: boolean; onConfirm: () => void } | null>(null)
  const [entretienBusWarning, setEntretienBusWarning] = useState<{ show: boolean; onConfirm: () => void } | null>(null)
  const budget = getBudgetState()

  const totalLeverImpact = calculateTotalImpact(financingLevers)

  // Handle gratuité totale toggle - reset tariffs when enabled
  const handleGratuiteTotaleChange = (checked: boolean) => {
    if (checked) {
      setFinancingLever('tarifAbonnements', 0)
      setFinancingLever('tarifTickets', 0)
    }
    setFinancingLever('gratuiteTotale', checked)
    if (checked) setFinancingLever('gratuiteConditionnee', false)
  }

  // Handle levers that require a law
  const handleLawLeverChange = (lever: keyof FinancingLevers, value: any, lawType: string) => {
    setLawPopup({
      show: true,
      lawType,
      onConfirm: () => {
        setFinancingLever(lever, value)
        setLawPopup(null)
      }
    })
  }

  return (
    <motion.div
      initial={{ opacity: 0, x: 50 }}
      animate={{ opacity: 1, x: 0 }}
      className="bg-white dark:bg-gray-800  rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
    >
      {/* Header */}
      <div className="p-4 bg-gradient-to-r from-green-600/100 to-emerald-600/100 border-b border-gray-700/50">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
            <Coins className="w-5 h-5 text-gray-900 dark:text-white" />
          </div>
          <div>
            <h2 className="text-gray-900 dark:text-white font-bold">Leviers de Financement</h2>
            <p className="text-gray-600 dark:text-gray-400 text-sm">Ajustez vos sources de revenus</p>
          </div>
        </div>
        
        {/* Total impact indicator */}
        <div className={cn(
          "mt-3 px-3 py-2 rounded-xl flex items-center justify-between",
          totalLeverImpact >= 0 ? "bg-green-500/20" : "bg-red-500/20"
        )}>
          <span className="text-gray-700 dark:text-gray-300 text-sm">Impact total leviers</span>
          <span className={cn(
            "font-bold",
            totalLeverImpact >= 0 ? "text-green-400" : "text-red-400"
          )}>
            {totalLeverImpact >= 0 ? '+' : ''}{formatCurrency(totalLeverImpact)}/mandat
          </span>
        </div>
      </div>

      {/* Law Popup */}
      <AnimatePresence>
        {lawPopup?.show && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/100  z-[100] flex items-center justify-center p-4"
            onClick={() => setLawPopup(null)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="bg-white dark:bg-gray-800 rounded-2xl border border-yellow-500/100 p-6 max-w-md w-full shadow-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center">
                  <Gavel className="w-6 h-6 text-gray-900 dark:text-white" />
                </div>
                <div>
                  <h3 className="text-gray-900 dark:text-white font-bold text-lg">Loi requise</h3>
                  <p className="text-yellow-400 text-sm">{lawPopup.lawType}</p>
                </div>
              </div>
              <p className="text-gray-700 dark:text-gray-300 mb-6">
                Cette mesure nécessite un <strong className="text-gray-900 dark:text-white">changement législatif au niveau national</strong>. 
                Vous devrez convaincre le gouvernement et le parlement d&apos;adopter cette loi.
              </p>
              <div className="flex gap-3">
                <button
                  onClick={() => setLawPopup(null)}
                  className="flex-1 py-3 px-4 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-400 dark:bg-gray-600 transition-colors"
                >
                  Annuler
                </button>
                <button
                  onClick={lawPopup.onConfirm}
                  className="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 text-gray-900 dark:text-white font-bold hover:opacity-90 transition-opacity"
                >
                  J&apos;assume !
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Budget Warning Popup */}
      <AnimatePresence>
        {budgetWarning?.show && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/100  z-[100] flex items-center justify-center p-4"
            onClick={() => setBudgetWarning(null)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="bg-white dark:bg-gray-800 rounded-2xl border border-red-500/100 p-6 max-w-md w-full shadow-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center">
                  <AlertTriangle className="w-6 h-6 text-gray-900 dark:text-white" />
                </div>
                <div>
                  <h3 className="text-gray-900 dark:text-white font-bold text-lg">Budget en déficit !</h3>
                  <p className="text-red-400 text-sm">Financement insuffisant</p>
                </div>
              </div>
              <p className="text-gray-700 dark:text-gray-300 mb-4">
                Votre budget passerait en <strong className="text-red-400">déficit de {formatCurrency(Math.abs(budgetWarning.deficit))}</strong>.
              </p>
              <p className="text-gray-700 dark:text-gray-300 mb-6">
                Les 2 milliards de base par mandat représentent déjà l&apos;équilibre très endetté du Sytral. 
                <strong className="text-gray-900 dark:text-white"> Vous devez trouver des financements supplémentaires</strong> avant de valider ce projet.
              </p>
              <button
                onClick={() => setBudgetWarning(null)}
                className="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-red-500 to-orange-500 text-gray-900 dark:text-white font-bold hover:opacity-90 transition-opacity"
              >
                Compris, je vais ajuster mon budget
              </button>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Electrification Warning Popup */}
      <AnimatePresence>
        {electrificationWarning?.show && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/100  z-[100] flex items-center justify-center p-4"
            onClick={() => setElectrificationWarning(null)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="bg-white dark:bg-gray-800 rounded-2xl border border-orange-500/100 p-6 max-w-md w-full shadow-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center">
                  <AlertTriangle className="w-6 h-6 text-gray-900 dark:text-white" />
                </div>
                <div>
                  <h3 className="text-gray-900 dark:text-white font-bold text-lg">Attention !</h3>
                  <p className="text-orange-400 text-sm">Désactivation de l&apos;électrification</p>
                </div>
              </div>
              <div className="space-y-3 mb-6">
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Impacts écologiques :</strong> Maintien des émissions de CO2 et de particules fines, aggravation de la pollution de l&apos;air.
                </p>
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Coûts de maintenance :</strong> Les bus thermiques nécessitent plus d&apos;entretien (moteur, échappement, filtres).
                </p>
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Coûts de carburant :</strong> Dépendance au diesel dont le prix est volatile et en hausse.
                </p>
                <p className="text-red-400 font-bold">
                  Sur le long terme, c&apos;est perdant économiquement et écologiquement.
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => setElectrificationWarning(null)}
                  className="flex-1 py-3 px-4 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-400 dark:bg-gray-600 transition-colors"
                >
                  Annuler
                </button>
                <button
                  onClick={electrificationWarning.onConfirm}
                  className="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-gray-900 dark:text-white font-bold hover:opacity-90 transition-opacity"
                >
                  Désactiver quand même
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Entretien Bus Warning Popup */}
      <AnimatePresence>
        {entretienBusWarning?.show && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/100  z-[100] flex items-center justify-center p-4"
            onClick={() => setEntretienBusWarning(null)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="bg-white dark:bg-gray-800 rounded-2xl border border-red-500/100 p-6 max-w-md w-full shadow-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center">
                  <AlertTriangle className="w-6 h-6 text-gray-900 dark:text-white" />
                </div>
                <div>
                  <h3 className="text-gray-900 dark:text-white font-bold text-lg">Danger !</h3>
                  <p className="text-red-400 text-sm">Désactivation de l&apos;entretien de la flotte</p>
                </div>
              </div>
              <div className="space-y-3 mb-6">
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Sécurité des usagers :</strong> Augmentation drastique des risques de pannes et d&apos;accidents. Mise en danger des voyageurs.
                </p>
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Qualité de service :</strong> Multiplication des retards, annulations et interruptions de service. Dégradation de l&apos;image du réseau TCL.
                </p>
                <p className="text-gray-700 dark:text-gray-300">
                  <strong className="text-gray-900 dark:text-white">Coûts exponentiels :</strong> Les réparations d&apos;urgence coûtent 3 à 5 fois plus cher que l&apos;entretien préventif.
                </p>
                <p className="text-red-400 font-bold">
                  Sans entretien, le réseau de bus s&apos;effondrera en quelques mois. C&apos;est irresponsable et intenable.
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => setEntretienBusWarning(null)}
                  className="flex-1 py-3 px-4 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-400 dark:bg-gray-600 transition-colors"
                >
                  Annuler
                </button>
                <button
                  onClick={entretienBusWarning.onConfirm}
                  className="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-red-500 to-orange-500 text-gray-900 dark:text-white font-bold hover:opacity-90 transition-opacity"
                >
                  Désactiver quand même
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Section Tarification Sociale */}
      <div className="p-4 border-b border-gray-700/50">
        <h3 className="text-gray-900 dark:text-white font-bold text-sm mb-3 flex items-center gap-2">
          <Users className="w-4 h-4 text-purple-400" />
          Tarification Sociale
        </h3>
        <div className="space-y-3">
          {/* Gratuité Totale */}
          <LeverToggle
            lever="gratuiteTotale"
            info={leverInfos.gratuiteTotale}
            checked={financingLevers.gratuiteTotale}
            disabled={financingLevers.gratuiteConditionnee}
            onChange={handleGratuiteTotaleChange}
            expanded={expandedLever === 'gratuiteTotale'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'gratuiteTotale' ? null : 'gratuiteTotale')}
          />

          {/* Gratuité Conditionnée (Aulas) */}
          <LeverToggle
            lever="gratuiteConditionnee"
            info={leverInfos.gratuiteConditionnee}
            checked={financingLevers.gratuiteConditionnee}
            disabled={financingLevers.gratuiteTotale}
            onChange={(checked) => setFinancingLever('gratuiteConditionnee', checked)}
            expanded={expandedLever === 'gratuiteConditionnee'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'gratuiteConditionnee' ? null : 'gratuiteConditionnee')}
          />

          {/* Gratuité 11-18 ans */}
          <LeverToggle
            lever="gratuiteJeunesAbonnes"
            info={leverInfos.gratuiteJeunesAbonnes}
            checked={financingLevers.gratuiteJeunesAbonnes}
            onChange={(checked) => setFinancingLever('gratuiteJeunesAbonnes', checked)}
            expanded={expandedLever === 'gratuiteJeunesAbonnes'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'gratuiteJeunesAbonnes' ? null : 'gratuiteJeunesAbonnes')}
          />

          {/* Métro 24h/24 weekends */}
          <LeverToggle
            lever="metro24hWeekend"
            info={leverInfos.metro24hWeekend}
            checked={financingLevers.metro24hWeekend}
            onChange={(checked) => setFinancingLever('metro24hWeekend', checked)}
            expanded={expandedLever === 'metro24hWeekend'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'metro24hWeekend' ? null : 'metro24hWeekend')}
          />
        </div>
      </div>

      {/* Section Tarification */}
      <div className="p-4 border-b border-gray-700/50">
        <h3 className="text-gray-900 dark:text-white font-bold text-sm mb-3 flex items-center gap-2">
          <CreditCard className="w-4 h-4 text-blue-400" />
          Tarification
          {financingLevers.gratuiteTotale && (
            <span className="text-xs text-red-400 ml-2">(Bloqué - Gratuité totale active)</span>
          )}
        </h3>
        <div className="space-y-3">
          {/* Tarif Abonnements */}
          <LeverSlider
            lever="tarifAbonnements"
            info={leverInfos.tarifAbonnements}
            value={financingLevers.tarifAbonnements}
            onChange={(val) => setFinancingLever('tarifAbonnements', val)}
            min={0}
            max={50}
            basePrice={BASE_PRICES.abonnement}
            impactPerPercent={12}
            expanded={expandedLever === 'tarifAbonnements'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'tarifAbonnements' ? null : 'tarifAbonnements')}
            disabled={financingLevers.gratuiteTotale}
          />

          {/* Tarif Tickets */}
          <LeverSlider
            lever="tarifTickets"
            info={leverInfos.tarifTickets}
            value={financingLevers.tarifTickets}
            onChange={(val) => setFinancingLever('tarifTickets', val)}
            min={0}
            max={50}
            basePrice={BASE_PRICES.ticket}
            impactPerPercent={8}
            expanded={expandedLever === 'tarifTickets'}
            onToggleExpand={() => setExpandedLever(expandedLever === 'tarifTickets' ? null : 'tarifTickets')}
            disabled={financingLevers.gratuiteTotale}
          />
        </div>
      </div>

      {/* Section Fiscalité */}
      <div className="p-4 space-y-3">
        <h3 className="text-gray-900 dark:text-white font-bold text-sm mb-3 flex items-center gap-2">
          <Building2 className="w-4 h-4 text-green-400" />
          Fiscalité
          <span className="text-xs text-yellow-400/100 ml-2">(Nécessite une loi)</span>
        </h3>

        {/* Versement Mobilité */}
        <LeverSelect
          lever="versementMobilite"
          info={leverInfos.versementMobilite}
          value={financingLevers.versementMobilite}
          onChange={(val) => {
            if (val > 0) {
              handleLawLeverChange('versementMobilite', val as -25 | 0 | 25 | 50, 'Augmentation du Versement Mobilité')
            } else {
              setFinancingLever('versementMobilite', val as -25 | 0 | 25 | 50)
            }
          }}
          expanded={expandedLever === 'versementMobilite'}
          onToggleExpand={() => setExpandedLever(expandedLever === 'versementMobilite' ? null : 'versementMobilite')}
        />

        {/* TVA 5.5% */}
        <LeverToggle
          lever="tva55"
          info={leverInfos.tva55}
          checked={financingLevers.tva55}
          onChange={(checked) => {
            if (checked) {
              handleLawLeverChange('tva55', true, 'Baisse de la TVA à 5,5%')
            } else {
              setFinancingLever('tva55', false)
            }
          }}
          expanded={expandedLever === 'tva55'}
          onToggleExpand={() => setExpandedLever(expandedLever === 'tva55' ? null : 'tva55')}
          showLawBadge
        />

        {/* Électrification des Bus */}
        <LeverPeriodSelect
          lever="electrificationBus"
          info={leverInfos.electrificationBus}
          value={financingLevers.electrificationBus}
          onChange={(val) => {
            if (val === null && financingLevers.electrificationBus !== null) {
              setElectrificationWarning({
                show: true,
                onConfirm: () => {
                  setFinancingLever('electrificationBus', null)
                  setElectrificationWarning(null)
                }
              })
            } else {
              setFinancingLever('electrificationBus', val)
            }
          }}
          expanded={expandedLever === 'electrificationBus'}
          onToggleExpand={() => setExpandedLever(expandedLever === 'electrificationBus' ? null : 'electrificationBus')}
        />

        {/* Entretien Flotte de Bus */}
        <LeverPeriodSelect
          lever="entretienBus"
          info={leverInfos.entretienBus}
          value={financingLevers.entretienBus}
          onChange={(val) => {
            if (val === null && financingLevers.entretienBus !== null) {
              setEntretienBusWarning({
                show: true,
                onConfirm: () => {
                  setFinancingLever('entretienBus', null)
                  setEntretienBusWarning(null)
                }
              })
            } else {
              setFinancingLever('entretienBus', val)
            }
          }}
          expanded={expandedLever === 'entretienBus'}
          onToggleExpand={() => setExpandedLever(expandedLever === 'entretienBus' ? null : 'entretienBus')}
        />
      </div>

      {/* Educational tip */}
      <div className="p-4 bg-green-500/100 border-t border-green-500/20">
        <div className="flex gap-3">
          <Lightbulb className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" />
          <p className="text-green-300/100 text-sm">
            <strong>Conseil :</strong> Équilibrez augmentation des tarifs et aides sociales pour maintenir l&apos;attractivité du réseau tout en finançant vos projets.
          </p>
        </div>
      </div>
    </motion.div>
  )
}

function LeverToggle({ 
  lever, 
  info, 
  checked, 
  disabled,
  onChange, 
  expanded, 
  onToggleExpand,
  showLawBadge = false,
}: {
  lever: string
  info: LeverInfo
  checked: boolean
  disabled?: boolean
  onChange: (checked: boolean) => void
  expanded: boolean
  onToggleExpand: () => void
  showLawBadge?: boolean
}) {
  const Icon = info.icon

  return (
    <div className={cn(
      "rounded-xl border transition-all",
      checked ? "border-blue-500/100 bg-blue-500/10" : "border-gray-700/100 bg-gray-900/30",
      showLawBadge && !checked ? "border-yellow-500/30" : ""
    )}>
      <div className="p-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-8 h-8 rounded-lg flex items-center justify-center bg-gradient-to-br",
              info.color
            )}>
              <Icon className="w-4 h-4 text-gray-900 dark:text-white" />
            </div>
            <div>
              <p className="text-gray-900 dark:text-white font-medium text-sm">{info.title}</p>
              <p className="text-red-400 text-xs font-medium">{info.impact}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={onToggleExpand} className="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white">
              {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            </button>
            <Switch 
              checked={checked} 
              onCheckedChange={onChange}
              disabled={disabled}
            />
          </div>
        </div>
        
        {expanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="mt-3 pt-3 border-t border-gray-700/50"
          >
            <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">{info.description}</p>
            {info.warning && (
              <div className="flex gap-2 text-yellow-500/100 text-xs">
                <AlertTriangle className="w-4 h-4 flex-shrink-0" />
                <span>{info.warning}</span>
              </div>
            )}
          </motion.div>
        )}
      </div>
    </div>
  )
}

function LeverSlider({
  lever,
  info,
  value,
  onChange,
  min,
  max,
  basePrice,
  impactPerPercent,
  expanded,
  onToggleExpand,
  disabled = false,
}: {
  lever: string
  info: LeverInfo
  value: number
  onChange: (val: number) => void
  min: number
  max: number
  basePrice: number
  impactPerPercent: number
  expanded: boolean
  onToggleExpand: () => void
  disabled?: boolean
}) {
  const Icon = info.icon
  const impact = value * impactPerPercent
  const currentPrice = basePrice * (1 + value / 100)

  return (
    <div className={cn(
      "rounded-xl border transition-all",
      disabled ? "opacity-50 pointer-events-none" : "",
      value !== 0 ? "border-blue-500/100 bg-blue-500/10" : "border-gray-700/100 bg-gray-900/30"
    )}>
      <div className="p-3">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-8 h-8 rounded-lg flex items-center justify-center bg-gradient-to-br",
              info.color
            )}>
              <Icon className="w-4 h-4 text-gray-900 dark:text-white" />
            </div>
            <div>
              <p className="text-gray-900 dark:text-white font-medium text-sm">{info.title}</p>
              <p className="text-gray-500 text-xs">Base: {basePrice.toFixed(2)}€</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <div className="text-right">
              <p className={cn(
                "font-bold",
                value > 0 ? "text-green-400" : value < 0 ? "text-red-400" : "text-gray-600 dark:text-gray-400"
              )}>
                {value > 0 ? '+' : ''}{value}%
              </p>
              <p className={cn(
                "text-xs font-medium",
                value !== 0 ? "text-yellow-400" : "text-gray-500"
              )}>
                → {currentPrice.toFixed(2)}€
              </p>
              <p className={cn(
                "text-xs",
                impact > 0 ? "text-green-400/70" : impact < 0 ? "text-red-400/70" : "text-gray-500"
              )}>
                {impact > 0 ? '+' : ''}{formatCurrency(impact)}
              </p>
            </div>
            <button onClick={onToggleExpand} className="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white">
              {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            </button>
          </div>
        </div>

        <Slider
          value={[value]}
          onValueChange={([val]) => onChange(val)}
          min={min}
          max={max}
          step={1}
          className="w-full"
          disabled={disabled}
        />

        {expanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="mt-3 pt-3 border-t border-gray-700/50"
          >
            <p className="text-gray-600 dark:text-gray-400 text-sm">{info.description}</p>
            <p className="text-gray-500 text-xs mt-2">
              Prix actuel: <span className="text-gray-900 dark:text-white font-medium">{currentPrice.toFixed(2)}€</span>
              {value !== 0 && (
                <span className={value > 0 ? "text-green-400" : "text-red-400"}>
                  {' '}({value > 0 ? '+' : ''}{(currentPrice - basePrice).toFixed(2)}€)
                </span>
              )}
            </p>
          </motion.div>
        )}
      </div>
    </div>
  )
}

function LeverSelect({
  lever,
  info,
  value,
  onChange,
  expanded,
  onToggleExpand,
}: {
  lever: string
  info: LeverInfo
  value: number
  onChange: (val: number) => void
  expanded: boolean
  onToggleExpand: () => void
}) {
  const Icon = info.icon
  const options = [
    { value: -25, label: '-25%', impact: '-700 M€' },
    { value: 0, label: 'Actuel', impact: '0 M€' },
    { value: 25, label: '+25%', impact: '+700 M€' },
    { value: 50, label: '+50%', impact: '+1 400 M€' },
  ]

  return (
    <div className={cn(
      "rounded-xl border transition-all",
      value !== 0 ? "border-blue-500/100 bg-blue-500/10" : "border-gray-700/100 bg-gray-900/30"
    )}>
      <div className="p-3">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-8 h-8 rounded-lg flex items-center justify-center bg-gradient-to-br",
              info.color
            )}>
              <Icon className="w-4 h-4 text-gray-900 dark:text-white" />
            </div>
            <div>
              <p className="text-gray-900 dark:text-white font-medium text-sm">{info.title}</p>
              <p className="text-gray-500 text-xs">{info.impact}</p>
            </div>
          </div>
          <button onClick={onToggleExpand} className="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white">
            {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
          </button>
        </div>

        <div className="grid grid-cols-4 gap-2">
          {options.map((opt) => (
            <button
              key={opt.value}
              onClick={() => onChange(opt.value)}
              className={cn(
                "py-2 px-2 rounded-lg text-xs font-medium transition-all",
                value === opt.value
                  ? "bg-gradient-to-r from-green-500 to-emerald-500 text-gray-900 dark:text-white"
                  : "bg-gray-900/100 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white hover:bg-gray-300 dark:bg-gray-700/50"
              )}
            >
              <span className="block">{opt.label}</span>
              <span className={cn(
                "block text-xs",
                opt.value > 0 ? "text-green-400/70" : opt.value < 0 ? "text-red-400/70" : ""
              )}>
                {opt.impact}
              </span>
            </button>
          ))}
        </div>

        {expanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="mt-3 pt-3 border-t border-gray-700/50"
          >
            <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">{info.description}</p>
            {info.warning && (
              <div className="flex gap-2 text-yellow-500/100 text-xs">
                <AlertTriangle className="w-4 h-4 flex-shrink-0" />
                <span>{info.warning}</span>
              </div>
            )}
          </motion.div>
        )}
      </div>
    </div>
  )
}

function LeverPeriodSelect({
  lever,
  info,
  value,
  onChange,
  expanded,
  onToggleExpand,
}: {
  lever: string
  info: LeverInfo
  value: MandatPeriod
  onChange: (val: MandatPeriod) => void
  expanded: boolean
  onToggleExpand: () => void
}) {
  const Icon = info.icon
  const options: { value: MandatPeriod; label: string }[] = [
    { value: null, label: 'Désactivé' },
    { value: 'M1', label: 'Mandat 1' },
    { value: 'M2', label: 'Mandat 2' },
    { value: 'M1+M2', label: 'M1+M2' },
  ]

  return (
    <div className={cn(
      "rounded-xl border transition-all",
      value !== null ? "border-blue-500/100 bg-blue-500/10" : "border-gray-700/100 bg-gray-900/30"
    )}>
      <div className="p-3">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-8 h-8 rounded-lg flex items-center justify-center bg-gradient-to-br",
              info.color
            )}>
              <Icon className="w-4 h-4 text-gray-900 dark:text-white" />
            </div>
            <div>
              <p className="text-gray-900 dark:text-white font-medium text-sm">{info.title}</p>
              <p className="text-gray-500 text-xs">{info.impact}</p>
            </div>
          </div>
          <button onClick={onToggleExpand} className="p-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white">
            {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
          </button>
        </div>

        <div className="grid grid-cols-4 gap-2">
          {options.map((opt) => (
            <button
              key={opt.label}
              onClick={() => onChange(opt.value)}
              className={cn(
                "py-2 px-2 rounded-lg text-xs font-medium transition-all",
                value === opt.value
                  ? "bg-gradient-to-r from-green-500 to-emerald-500 text-gray-900 dark:text-white"
                  : "bg-gray-900/100 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:text-white hover:bg-gray-300 dark:bg-gray-700/50"
              )}
            >
              {opt.label}
            </button>
          ))}
        </div>

        {expanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="mt-3 pt-3 border-t border-gray-700/50"
          >
            <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">{info.description}</p>
            {info.warning && (
              <div className="flex gap-2 text-yellow-500/100 text-xs">
                <AlertTriangle className="w-4 h-4 flex-shrink-0" />
                <span>{info.warning}</span>
              </div>
            )}
          </motion.div>
        )}
      </div>
    </div>
  )
}

function calculateTotalImpact(levers: FinancingLevers): number {
  let impact = 0
  if (levers.gratuiteTotale) impact -= 1925
  if (levers.gratuiteConditionnee) impact -= 300
  if (levers.gratuiteJeunesAbonnes) impact -= 48
  if (levers.metro24hWeekend) impact -= 24
  // Les tarifs ne s'appliquent pas si gratuité totale
  if (!levers.gratuiteTotale) {
    impact += levers.tarifAbonnements * 12
    impact += levers.tarifTickets * 8
  }
  const vmImpacts: Record<string, number> = { '-25': -700, '0': 0, '25': 700, '50': 1400 }
  impact += vmImpacts[levers.versementMobilite.toString()] || 0
  if (levers.tva55) impact += 96
  // electrificationBus is now handled as a project cost, not a lever impact
  return impact
}
